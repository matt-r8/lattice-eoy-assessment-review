version: '3.8'

services:
  # Firewall Manager Container
  # Privileged container with NET_ADMIN capability to manage iptables
  # Provides network namespace shared by ai-assistant container
  firewall-manager:
    image: alpine:latest
    container_name: ${PROJECT_NAME:-cui}-firewall-manager
    cap_add:
      - NET_ADMIN
    volumes:
      # Mount firewall configuration files as read-only
      - ../firewall/whitelist.txt:/firewall/whitelist.txt:ro
      - ../firewall/init-firewall.sh:/firewall/init-firewall.sh:ro
      # Mount Zscaler CA certificate for SSL inspection environments
      - ../firewall/certs/zscaler-root-ca.crt:/usr/local/share/ca-certificates/zscaler-root-ca.crt:ro
    command: /bin/sh -c "mkdir -p /etc/ssl/certs && cp /usr/local/share/ca-certificates/zscaler-root-ca.crt /etc/ssl/certs/ && cat /usr/local/share/ca-certificates/zscaler-root-ca.crt > /etc/ssl/certs/ca-certificates.crt && apk add --no-cache ca-certificates iptables bind-tools && update-ca-certificates && /firewall/init-firewall.sh && sleep infinity"
    healthcheck:
      test: ["CMD-SHELL", "iptables -L OUTPUT -n | grep -q 'policy DROP' && iptables -L OUTPUT -n | grep -q 'dpt:53'"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 45s
    restart: unless-stopped

  # AI Assistant Container
  # Unprivileged container with no capabilities
  # Shares network namespace with firewall-manager
  ai-assistant:
    image: ghcr.io/rise8-us/xpai/ai-assistant-home@sha256:179f0024131b091ef8d48e98a52a60f5e9bdeb60ca2aa8c2da62e1c445c4ef50
    container_name: ${PROJECT_NAME:-cui}-ai-assistant
    network_mode: "service:firewall-manager"
    cap_drop:
      - ALL
    depends_on:
      firewall-manager:
        condition: service_healthy
    volumes:
      # Mount workspace (adjust path as needed)
      - ../:/workspace:cached
    working_dir: /workspace
    env_file:
      - ../.env.bedrock
      - ../.env
    restart: unless-stopped
    # Keep container running
    command: sleep infinity